<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Silkscreen:wght@400;700&display=swap" rel="stylesheet">
    <title>Match Module</title>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body>
  <div class="leaderboard-list" id="leaderboard_list">

  </div>
</body>

<script type="text/javascript">
class Leaderboard {
  #id;

  constructor()
  {
    this.#id = 0;
  }

    #createElement(tag, attributes = {}, ...children)
    {
        const element = document.createElement(tag);

        for(const [key, value] of Object.entries(attributes))
                element.setAttribute(key, value);

        for(const child of children)
            if(typeof child === 'string')
                element.appendChild(document.createTextNode(child));
            else
                element.appendChild(child);

        return element;
    }

    #createTeamDiv(image_player, pseudo_player, teamSide)
    {
        const teamImg = this.#createElement("img", {
            src: "." + image_player,
            alt: pseudo_player,
            class: "team-logo"
        });

        const teamName = this.#createElement("div",{
            class: "team-name",
        }, pseudo_player);

        return this.#createElement("div", {
            class: "team " + teamSide
        }, teamImg, teamName);

    }

    #createMatchInfo(score, win)
    {
        const scoreDiv = this.#createElement("div", {
            class: "score",
        }, score);

        const timeDiv = this.#createElement("div",{
            class: win ? "win-match press-start-2p-regular" : "loose-match press-start-2p-regular"
        }, win ? "WIN" : "LOOSE");

        return this.#createElement("div", {
            class: "match-info silkscreen-regular"
        }, scoreDiv, timeDiv);
    }

    #createMatchModule(image_playerA, pseudo_playerA, image_playerB, pseudo_playerB, score, win) {
        const teamLeftDiv = this.#createTeamDiv(image_playerA, pseudo_playerA, "team-left");
        const teamRightDiv = this.#createTeamDiv(image_playerB, pseudo_playerB, "team-right");
        const matchInfoDiv = this.#createMatchInfo(score, win);

        return this.#createElement("div", {
            class: "match-module",
            id: "ldb_matchbox_"+this.#id,
            onclick: "leaderboard.toggleScoreStore('"+this.#id+"')"
        }, teamLeftDiv, matchInfoDiv, teamRightDiv);
    }

    #createLogoDiv(blockchain, ether_link) {
        const stored = this.#createElement("span", {
            class: "logo-text"
        }, " Match in");

        const ethLogoImg = this.#createElement("img", {
            src: blockchain ? "Ethereum%20Icon.svg" : "database2.svg",
            alt: blockchain ? "Etherum logo" : "Databse logo",
            class: blockchain ? "eth-logo" : "db-logo"
        });

        const logoDiv = this.#createElement("div", {
            class: "logo"
        });

        const logoBoxDiv = this.#createElement("a",{
            class: "logo-box",
            ...(blockchain && {
                class: "logo-box clickable-logo",
                href: ether_link
            })
        }, stored, ethLogoImg, logoDiv);

        return this.#createElement("div", {
            class: "logo-main animation-info",
            id: "ldb_info_"+this.#id
        }, logoBoxDiv);
    }

    toggleScoreStore(id)
    {
        if (document.getElementById("ldb_info_" + id).style.marginTop == "90px") {
            document.getElementById("ldb_matchbox_" + id).style.background = "";
            document.getElementById("ldb_match_" + id).style.height = "94px";
            document.getElementById("ldb_info_" + id).style.marginTop = "60px";
        }
        else {
            document.getElementById("ldb_matchbox_" + id).style.background = "#222223";
            document.getElementById("ldb_match_" + id).style.height = "124px";
            document.getElementById("ldb_info_" + id).style.marginTop = "90px";
        }
    }

    addMatch(pseudo_playerA, pseudo_playerB, image_playerA, image_playerB, score, win, blockchain, ether_link)
    {
        const matchModuleDiv = this.#createMatchModule(image_playerA, pseudo_playerA, image_playerB, pseudo_playerB, score, win)
        const logoMainDiv = this.#createLogoDiv(blockchain, ether_link)
        const matchDiv = this.#createElement("div", {
            class: "match animation-info unselectable",
            id: "ldb_match_"+this.#id
        }, matchModuleDiv, logoMainDiv);

        document.getElementById("leaderboard_list").appendChild(matchDiv);
        this.#id += 1;
    }
}

let leaderboard = new Leaderboard();

fetch("http://localhost:8000/front/history/13")
	.then((reponse) => {
        if(reponse.ok)
		    reponse.json().then((datas) => {
                for(const data of datas)
                {
                    score = data["player1_score"] + " - " + data["player2_score"]
                    eth_link = "https://sepolia.etherscan.io/tx/" + data["tx_hash"]
                    leaderboard.addMatch(data["player1_id"], data["player2_id"], data["player1_img"], data["player2_img"], score, data["win"], data["from_blockchain"], eth_link)
                }
            })
        else
            console.log("wrong request")
	})
    .catch(() => {
        console.log("wrong API call")
    })
</script>
</html>
